import { basicSetup, EditorView } from '@codemirror/basic-setup';
import React, { useState, useEffect, useRef } from 'react';
import { EditorState, Compartment, StateEffect } from '@codemirror/state';
import { linter } from '@codemirror/lint';
import { tablature, tabLint } from 'lang-tablature';
import './editor.css';

type Props = {
    delay?: number
}

let defaultProps = {
    delay: 500
}

let tablintrc = {};
function createLinterExtension(tablintrc:any) {
    return linter(tabLint(tablintrc), {
        delay: 5000
    });
}

let lintCompartment = new Compartment();
let langCompartment = new Compartment();

export const editorState:{view:EditorView|null} = {
    view: null
}

function Editor(props:Props = defaultProps) {
    const editorRef = useRef<HTMLDivElement>(null);
    const [view, setView] = useState<EditorView>();
    

    useEffect(() => {
        const s = EditorState.create({
            doc: getDemoTab(),
            extensions: [
                basicSetup,
                langCompartment.of(tablature()),
            ]
        });
        const v = new EditorView({
            state: s,
            parent: editorRef.current!
        });
        setView(v);
        editorState.view = v;
        return () => {
            v?.destroy();
        }
    }, []);

    //updating linter configuration
    // useEffect(() => {
    //     let lintExtension = createLinterExtension(tablintrc);
    //     if (view && lintCompartment.get(view.state)) {
    //         view?.dispatch({
    //             effects: lintCompartment.reconfigure(lintExtension)
    //         });
    //     }else {
    //         view?.dispatch({
    //             effects: StateEffect.appendConfig.of(lintExtension)
    //         })
    //     }
    // }, [view, tablintrc]);

    return (
        <div className='editor' ref={editorRef} />
    )
}

function getDemoTab() {
    return (
`Title:     Blackbird
Composer:  Paul McCartney
Group:     The Beatles
    
Note timing changes throughout.
    
    #1                          #2
    3/4 G       Am7     G/B     4/4 G
E{|---------------------------|-----------------------------------|
B{|---0-------1-------3-------|---12----12--12----12----12--12----|
G{|-------0-------0-------0---|-------0-------0-------0-------0---|
D{|---------------------------|-----------------------------------|
A{|-----------0-------2-------|---10------10------10------10------|
E{|---3-----------------------|-----------------------------------|
        +   .   +   .   +   .       +   .   +   .   +   .   +   .
    
    
    3/4 G       Am7     G/B     4/4 G
E||---------------------------|-----------------------------------|
B||---0-------1-------3-------|---12----12--12----12----12--12----|
G||.------0-------0-------0---|-------0-------0-------0-------0---|
D||.--------------------------|-----------------------------------|
A||-----------0-------2-------|---10------10------10------10------|
E||---3-----------------------|-----------------------------------|
        +   .   +   .   +   .       +   .   +   .   +   .   +   .
    1. Blackbird singing in the dead of night
    2. Blackbird singing in the dead of night
    
    
    #5
        C       A7      D       B7          Em              Eb
E |-----------------------------------|-----------------------------------|
B |---5-------8-------7-------10------|---8-----8---8-----8-----8---8-----|
G |-------0-------0-------0-------0---|-------0-------0-------0-------0---|
D |-----------------------------------|-----------------------------------|
A |---3-------7-------5-------9-------|---7-------7-------6-------6-------|
E |-----------------------------------|-----------------------------------|
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        Take these broken wings and learn to fly
        Take these sunken eyes and learn to see
    
    
    #7
    3/2 D       A7      C                Cm
E |----------------------------------------------------|
B |---7-------8-------5-----5---5------4-----4---4-----|
G |-------0-------0-------0-------0--------0-------0---|
D |----------------------------------------------------|
A |---5-------7-------3-------3--------3-------3-------|
E |----------------------------------------------------|
        +       .       +       .        +       .
        All     your    life
        All     your    life
    
    
    #8
        G/B             A7               Am7     D7
E |----------------------------------------------------|
B |---3-----3---3-----2-----2---2------1-----1---1-----|
G |-------0-------0-------0-------0--------0-------0---|
D |------------------------------------0-------0-------|
A |---2-------2-------0-------0------------------------|
E |----------------------------------------------------|
        +       .       +       .        +       .
        You were only  waiting  for this  moment  to a-
        You were only  waiting  for this  moment  to be
    
    -----------------------------------------------------------------------...
    |  1.
    #9
    4/4 G               C       G/B         A7              D7(Am7)
E |-----------------------------------|-----------------------------------|
B |---0-----0---0-----5-------3-------|---2-----2---2-----1-----1---1-----|
G |-------0-------0-------0-------0---|-------0-------0-------0-------0---|
D |-----------------------------------|-------------------0-------0-------|
A |-------------------3-------2-------|---0-------0-----------------------|
E |---3-------3-----------------------|-----------------------------------|
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        rise.
    
    ... -----------------  -------------------
                        ||  2.               |
    #11                  ||                   |
    2/2 G
E |--------------------||-------------------|
B |---0-----0---0------||---0-----0---0-----|
G |-------0-------0---.||-------0-------0---|
D |-------------------.||-------------------|
A |--------------------||-------------------|
E |---3-------3--------||---3-------3-------|
        +   .   +   .         +   .   +   .
                                free.
    
    #13
    4/4 F       Em      Dm      C           Bb              C
E |-----------------------------------|-----------------------------------|
B |---10------8-------6-------5-------|---3-----3---3-----5-----5---5-----|
G |-------0-------0-------0-------0---|-------0-------0-------0-------0---|
D |-----------------------------------|-----------------------------------|
A |---8-------7-------5-------3-------|---1-------1-------3-------3-------|
E |-----------------------------------|-----------------------------------|
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        Black     -     bird,              fly,
    
    
    #15
    4/4 F       Em      Dm      C           Bb              A7
E |-----------------------------------|-----------------------------------|
B |---10------8-------6-------5-------|---3-----3---3-----2-----2---2-----|
G |-------0-------0-------0-------0---|-------0-------0-------0-------0---|
D |-----------------------------------|-----------------------------------|
A |---8-------7-------5-------3-------|---1-------1-------0-------0-------|
E |-----------------------------------|-----------------------------------|
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        Black     -     bird,              fly,                    into the
    
    #17
    2/4 D7(Am7)
E |----------------------|
B |---1-----1---1----1---|
G |-------0-------0------|
D |---0-------0----------|
A |----------------------|
E |----------------------|
        +   .   +   .
        light of a dark black
    
    
    #18
    3/4 G       Am7     G/B     4/4 G
E |---------------------------|-----------------------------------|
B |---0-------1-------3-------|---12----12--12----12----12--12----|
G |-------0-------0-------0---|-------0-------0-------0-------0---|
D |---------------------------|-----------------------------------|
A |-----------0-------2-------|---10------10------10------10------|
E |---3-----------------------|-----------------------------------|
        +   .   +   .   +   .       +   .   +   .   +   .   +   .
        night.
    
    
    #20
        C       A7      D       B7          Em              Eb
E |-----------------------------------|-----------------------------------|
B |---5-------8-------7-------10------|---8-----8---8-----8-----8---8-----|
G |-------0-------0-------0-------0---|-------0-------0-------0-------0---|
D |-----------------------------------|-----------------------------------|
A |---3-------7-------5-------9-------|---7-------7-------6-------6-------|
E |-----------------------------------|-----------------------------------|
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
    
    
    #22
    3/2 D       A7      C                Cm
E |----------------------------------------------------|
B |---7-------8-------5-----5---5------4-----4---4-----|
G |-------0-------0-------0-------0--------0-------0---|
D |----------------------------------------------------|
A |---5-------7-------3-------3--------3-------3-------|
E |----------------------------------------------------|
        +       .       +       .        +       .
    
    
    #23                                                  #24
        G/B             A7               D7(Am7)         2/4 G
E |----------------------------------------------------|---------------|
B |---3-----3---3-----2-----2---2------1-----1---1-----|---0-----------|
G |-------0-------0-------0-------0--------0-------0---|---0-----------|
D |------------------------------------0-------0-------|---------------|
A |---2-------2-------0-------0------------------------|---------------|
E |----------------------------------------------------|---3-----------|
        +       .       +       .        +       .           +       .
    
    
    #25
    4/4 F       Em      Dm      C           Bb              C
E |-----------------------------------|-----------------------------------|
B |---10------8-------6-------5-------|---3-----3---3-----5-----5---5-----|
G |-------0-------0-------0-------0---|-------0-------0-------0-------0---|
D |-----------------------------------|-----------------------------------|
A |---8-------7-------5-------3-------|---1-------1-------3-------3-------|
E |-----------------------------------|-----------------------------------|
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        Black     -     bird,               fly,
    
    
    #27
    4/4 F       Em      Dm      C           Bb              A7
E |-----------------------------------|-----------------------------------|
B |---10------8-------6-------5-------|---3-----3---3-----2-----2---2-----|
G |-------0-------0-------0-------0---|-------0-------0-------0-------0---|
D |-----------------------------------|-----------------------------------|
A |---8-------7-------5-------3-------|---1-------1-------0-------0-------|
E |-----------------------------------|-----------------------------------|
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        Black     -     bird,               fly,                    into the
    
    #29
    2/4 D7(Am7)
E |----------------------|
B |---1-----1---1----1---|
G |-------0-------0------|
D |---0-------0----------|
A |----------------------|
E |----------------------|
        +   .   +   .
    light of a dark, black
    
    
    #30
    3/4 G       Am7     G/B     4/4 G
E |---------------------------|-----------------------------------|
B |---0-------1-------3-------|---12----12--12----12----12--12----|
G |---------------------------|-------0-------0-------0-------0---|
D |---------------------------|-----------------------------------|
A |-----------0-------2-------|-----------------------------------|
E |---3-----------------------|---10------10------10------10------|
        +   .   +   .   +   .       +   .   +   .   +   .   +   .
        night.
    
    
    #31
        G
E |-----------------------------------|-----------------------------------|
B |---12----12--12----12----12--12----|---12----12--12----12--------------|
G |-------0-------0-------0-------0---|-------0-------0---0---------------|
D |-----------------------------------|-----------------------------------|
A |---10------10------10------10------|---10------10------10--------------|
E |-----------------------------------|-----------------------------------|
        +   .   +   .   +   .       +   .   +   .   +   .   +   .   +   .
                                molto rit.
    
    
    #34
    3/4    G       Am7     G/B     3/4 C       G       A7
E||------------------------------|---------------------------|
B||------0-------1-------3-------|---5-------3-------2-------|
G||----------0-------0-------0---|-------0-------0-------0---|
D||------------------------------|---------------------------|
A||--------------0-------2-------|---3-------2-------0-------|
E||---10\\3-----------------------|---------------------------|
            +   .   +   .   +   .      +   .   +   .   +   .
    slide down
        a tempo
    
    
    #36
    2/4 Am7/D
E |------------------|
B |--1-----1---1-----|
G |------0-------0---|
D |--0-------0-------|
A |------------------|
E |------------------|
        +   .   +   .
    
    #37
    3/4 G       Am7     G/B     4/4 G
E||---------------------------|-----------------------------------|
B||---0-------1-------3-------|---12----12--12----12----12--12----|
G||.------0-------0-------0---|-------0-------0-------0-------0---|
D||.--------------------------|-----------------------------------|
A||-----------0-------2-------|---10------10------10------10------|
E||---3-----------------------|-----------------------------------|
        +   .   +   .   +   .       +   .   +   .   +   .   +   .
    Blackbird singing in the dead of night
    
    
    #39
        C       A7      D       B7          Em              Eb
E |-----------------------------------|-----------------------------------|
B |---5-------8-------7-------10------|---8-----8---8-----8-----8---8-----|
G |-------0-------0-------0-------0---|-------0-------0-------0-------0---|
D |-----------------------------------|-----------------------------------|
A |---3-------7-------5-------9-------|---7-------7-------6-------6-------|
E |-----------------------------------|-----------------------------------|
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        Take these broken wings and learn to fly;
    
    
    #41
    3/2 G       A7      C                Cm
E |----------------------------------------------------|
B |---7-------8-------5-----5---5------4-----4---4-----|
G |-------0-------0-------0-------0--------0-------0---|
D |----------------------------------------------------|
A |---5-------7-------3-------3--------3-------3-------|
E |----------------------------------------------------|
        +       .       +       .        +       .
        All     your    life
    
    
    #42
    4/4 G/B             A7                  Am7             G
E||-----------------------------------|-----------------------------------||
B||---3-----3---3-----2-----2---2-----|---1-----1---1-----0---------------||
G||.------0-------0-------0-------0---|-------0-------0---0--------------.||
D||.----------------------------------|---0-------0----------------------.||
A||---2-------2-------0-------0-------|-----------------------------------||
E||-----------------------------------|-------------------3---------------||
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        You were only   waiting  for this    moment  to    a-rise.
    
    
    #44
        C       G/B     A7                  Am7     D7      G
E |-----------------------------------|-----------------------------------||}
B |---5-------3-------2-----2---2-----|---1-----1---1-----3---------------||}
G |-------0-------0-------0-------0---|-------0-------0---0---------------||}
D |-----------------------------------|---0-------0-------0---------------||}
A |---3-------2-------0-------0-------|-----------------------------------||}
E |-----------------------------------|-------------------3---------------||}
        +   .   +   .   +   .   +   .       +   .   +   .   +   .   +   .
        You were only   waiting  for this    moment  to    a-rise.`);
}

export default Editor;